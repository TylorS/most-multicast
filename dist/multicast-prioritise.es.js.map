{"version":3,"file":null,"sources":["../src/MulticastDisposable.js","../src/tryEvent.js","../src/dispose.js","../src/MulticastSource.js","../src/Prioritise.js","../src/index.js"],"sourcesContent":["export default class MulticastDisposable {\r\n  constructor (source, sink) {\r\n    this.source = source\r\n    this.sink = sink\r\n    this.disposed = false\r\n  }\r\n\r\n  dispose () {\r\n    if (this.disposed) {\r\n      return\r\n    }\r\n    this.disposed = true\r\n    const remaining = this.source.remove(this.sink)\r\n    return remaining === 0 && this.source._dispose()\r\n  }\r\n}\r\n","export function tryEvent (t, x, sink) {\r\n  try {\r\n    sink.event(t, x)\r\n  } catch (e) {\r\n    sink.error(t, e)\r\n  }\r\n}\r\n\r\nexport function tryEnd (t, x, sink) {\r\n  try {\r\n    sink.end(t, x)\r\n  } catch (e) {\r\n    sink.error(t, e)\r\n  }\r\n}\r\n","export const dispose = disposable => disposable.dispose()\r\n\r\nexport const emptyDisposable = {\r\n  dispose () {}\r\n}\r\n","import MulticastDisposable from './MulticastDisposable'\r\nimport { tryEvent, tryEnd } from './tryEvent'\r\nimport { dispose, emptyDisposable } from './dispose'\r\nimport { remove, findIndex } from '@most/prelude'\r\n\r\nfunction insertWhen (x, a, f) {\r\n  const l = a.length\r\n  const b = new Array(l + 1)\r\n\r\n  let i = 0\r\n  for (; i < l; ++i) {\r\n    if (f(x, a[i])) {\r\n      break\r\n    }\r\n    b[i] = a[i]\r\n  }\r\n\r\n  b[i] = x\r\n\r\n  for (; i < l; ++i) {\r\n    b[i + 1] = a[i]\r\n  }\r\n\r\n  return b\r\n}\r\n\r\nfunction comparePriority (a, b) {\r\n  return (a.priority || 0) > (b.priority || 0)\r\n}\r\n\r\nexport default class MulticastSource {\r\n  constructor (source) {\r\n    this.source = source\r\n    this.sinks = []\r\n    this._disposable = emptyDisposable\r\n  }\r\n\r\n  run (sink, scheduler) {\r\n    const n = this.add(sink)\r\n    if (n === 1) {\r\n      this._disposable = this.source.run(this, scheduler)\r\n    }\r\n    return new MulticastDisposable(this, sink)\r\n  }\r\n\r\n  _dispose () {\r\n    const disposable = this._disposable\r\n    this._disposable = emptyDisposable\r\n    return Promise.resolve(disposable).then(dispose)\r\n  }\r\n\r\n  add (sink) {\r\n    this.sinks = insertWhen(sink, this.sinks, comparePriority)\r\n    return this.sinks.length\r\n  }\r\n\r\n  remove (sink) {\r\n    const i = findIndex(sink, this.sinks)\r\n    // istanbul ignore next\r\n    if (i >= 0) {\r\n      this.sinks = remove(i, this.sinks)\r\n    }\r\n\r\n    return this.sinks.length\r\n  }\r\n\r\n  event (time, value) {\r\n    const s = this.sinks\r\n    if (s.length === 1) {\r\n      return s[0].event(time, value)\r\n    }\r\n    for (let i = 0; i < s.length; ++i) {\r\n      tryEvent(time, value, s[i])\r\n    }\r\n  }\r\n\r\n  end (time, value) {\r\n    const s = this.sinks\r\n    for (let i = 0; i < s.length; ++i) {\r\n      tryEnd(time, value, s[i])\r\n    }\r\n  }\r\n\r\n  error (time, err) {\r\n    const s = this.sinks\r\n    for (let i = 0; i < s.length; ++i) {\r\n      s[i].error(time, err)\r\n    }\r\n  }\r\n}\r\n","class Prioritise {\n  constructor (priority, source) {\n    this.source = source\n    this.priority = priority\n  }\n  run (sink, scheduler) {\n    sink.priority = this.priority\n    return this.source.run(sink, scheduler)\n  }\n}\n\nexport default Prioritise\n","import MulticastSource from './MulticastSource'\r\nimport Prioritise from './Prioritise'\r\n\r\nfunction multicast (stream) {\r\n  const source = stream.source\r\n  return source instanceof MulticastSource\r\n    ? stream\r\n    : new stream.constructor(new MulticastSource(source))\r\n}\r\n\r\nfunction prioritise (priority, stream) {\r\n  return !stream\r\n    ? prioritise.bind(this, priority)\r\n    : new stream.constructor(new Prioritise(priority, stream.source))\r\n}\r\n\r\nexport {multicast, MulticastSource, prioritise, Prioritise}\r\n"],"names":["const","let"],"mappings":"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"}