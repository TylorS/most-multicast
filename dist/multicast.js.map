{"version":3,"file":null,"sources":["../src/MulticastDisposable.js","../src/tryEvent.js","../src/dispose.js","../src/MulticastSource.js","../src/index.js"],"sourcesContent":["export default class MulticastDisposable {\n  constructor (source, sink) {\n    this.source = source\n    this.sink = sink\n    this.disposed = false\n  }\n\n  dispose () {\n    if (this.disposed) {\n      return\n    }\n    this.disposed = true\n    const remaining = this.source.remove(this.sink)\n    return remaining === 0 && this.source._dispose()\n  }\n}\n","export function tryEvent (t, x, sink) {\n  try {\n    sink.event(t, x)\n  } catch (e) {\n    sink.error(t, e)\n  }\n}\n\nexport function tryEnd (t, x, sink) {\n  try {\n    sink.end(t, x)\n  } catch (e) {\n    sink.error(t, e)\n  }\n}\n","export const dispose = disposable => disposable.dispose()\n\nexport const emptyDisposable = {\n  dispose () {}\n}\n","import MulticastDisposable from './MulticastDisposable'\nimport { tryEvent, tryEnd } from './tryEvent'\nimport { dispose, emptyDisposable } from './dispose'\nimport { append, remove, findIndex } from '@most/prelude'\n\nexport default class MulticastSource {\n  constructor (source) {\n    this.source = source\n    this.sinks = []\n    this._disposable = emptyDisposable\n  }\n\n  run (sink, scheduler) {\n    const n = this.add(sink)\n    if (n === 1) {\n      this._disposable = this.source.run(this, scheduler)\n    }\n    return new MulticastDisposable(this, sink)\n  }\n\n  _dispose () {\n    const disposable = this._disposable\n    this._disposable = emptyDisposable\n    return Promise.resolve(disposable).then(dispose)\n  }\n\n  add (sink) {\n    this.sinks = append(sink, this.sinks)\n    return this.sinks.length\n  }\n\n  remove (sink) {\n    const i = findIndex(sink, this.sinks)\n    // istanbul ignore next\n    if (i >= 0) {\n      this.sinks = remove(i, this.sinks)\n    }\n\n    return this.sinks.length\n  }\n\n  event (time, value) {\n    const s = this.sinks\n    if (s.length === 1) {\n      return s[0].event(time, value)\n    }\n    for (let i = 0; i < s.length; ++i) {\n      tryEvent(time, value, s[i])\n    }\n  }\n\n  end (time, value) {\n    const s = this.sinks\n    for (let i = 0; i < s.length; ++i) {\n      tryEnd(time, value, s[i])\n    }\n  }\n\n  error (time, err) {\n    const s = this.sinks\n    for (let i = 0; i < s.length; ++i) {\n      s[i].error(time, err)\n    }\n  }\n}\n","import MulticastSource from './MulticastSource'\n\nfunction multicast (stream) {\n  const source = stream.source\n  return source instanceof MulticastSource\n    ? stream\n    : new stream.constructor(new MulticastSource(source))\n}\n\nexport {multicast as default, MulticastSource}\n"],"names":["const","append","findIndex","remove","let"],"mappings":"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"}